<div class="board">
{% for title, items in groups %}
    <section class="board-section" id="lane-{{ loop.index0 }}">
      <header class="section-header">
        <h2>
          {{ title }}{% if items|length is not none %} ({{ items|length }}){% endif %}
        </h2>
      </header>

      {% if items %}
        <div class="grid">
          {% for pr in items %}

            {# Determine strip colour #}
            {% set strip = "status-open" %}
            {% if pr.is_draft %}
                {% set strip = "status-draft" %}
            {% elif pr.state == "MERGED" %}
                {% set strip = "status-merged" %}
            {% elif pr.ci_summary and "FAILED" in pr.ci_summary %}
                {% set strip = "status-failed" %}
            {% endif %}

            {% set card_id = ("pr-" ~ pr.repo_owner ~ "-" ~ pr.repo_name ~ "-" ~ pr.number)|replace(" ", "-") %}
            <div
              class="card {% if pr.is_mine %}mine{% endif %}"
              id="{{ card_id }}"
              hx-get="/fragments/pr-table"
              hx-trigger="every 20s"
              hx-select="#{{ card_id }}"
              hx-target="this"
              hx-swap="morphdom"
              hx-ext="morphdom-swap"
            >
              <div class="status-strip {{ strip }}"></div>
              <div class="title">
                <a class="pr-link" href="{{ pr.url }}" target="_blank">
                  {{ pr.title }}
                </a>
                {% if pr.is_draft %}
                  <span class="pill pill-draft">Draft</span>
                {% endif %}
              </div>

              <div class="meta">
                <div class="avatar">
                  <img src="https://github.com/{{ pr.author }}.png" alt="">
                </div>
                <div>
                  <strong>{{ pr.author }}</strong><br>
                  <span>{{ pr.repo_owner }}/{{ pr.repo_name }} #{{ pr.number }}</span>
                </div>
              </div>

              <div class="meta">
                <span>Updated: {{ pr.updated_at }}</span>
              </div>
              {% if pr.state == "MERGED" %}
                <div class="meta">
                  <span>Merged: {{ pr.merged_at or pr.updated_at }}</span>
                </div>
              {% endif %}

              {% set size_points = pr.raw.get("size_sparkline", []) %}
              {% if size_points %}
                {% set max_val = size_points|max %}
                {% set total = size_points|length %}
                {% set fill_count = ((max_val * total) + 0.999) | int %}
                {% if max_val > 0 and fill_count < 1 %}{% set fill_count = 1 %}{% endif %}
                {% if fill_count > total %}{% set fill_count = total %}{% endif %}
                {% set last_idx = fill_count - 1 %}
                <div class="size-sparkline">
                  {% for val in size_points %}
                    {% set idx = loop.index0 %}
                    {% set filled = idx <= last_idx and max_val > 0 %}
                    {% set is_last = idx == last_idx and filled %}
                    {% set hue = 120 - (120 * val) %}
                    {% set height = 6 + (val * 12) %}
                    {% set alpha = 0.6 + (val * 0.4) %}
                    {% set glow = 6 + val * 10 %}
                    {% set fade = 0.15 + ((total - idx) / total) * 0.12 %}
                    {% set muted_opacity = fade if idx > last_idx else 0.55 %}
                    <span
                      class="size-spark-bar {% if filled %}filled{% else %}muted{% endif %} {% if is_last %}last-filled{% endif %}"
                      style="
                        height: {{ '%.1f' % height }}px;
                        {% if filled %}
                          background: linear-gradient(180deg, hsla({{ '%.0f' % hue }}, 80%, 60%, {{ '%.2f' % alpha }}), hsla({{ '%.0f' % hue }}, 80%, 50%, {{ '%.2f' % (alpha + 0.2) }}));
                          opacity: {{ '%.2f' % (0.6 + val * 0.4) }};
                          {% if is_last %}
                            box-shadow: 0 0 {{ '%.1f' % glow }}px hsla({{ '%.0f' % hue }}, 80%, 55%, {{ '%.2f' % (0.35 + val * 0.35) }});
                          {% endif %}
                        {% else %}
                          opacity: {{ '%.2f' % muted_opacity }};
                        {% endif %}
                      "
                    ></span>
                  {% endfor %}
                </div>
              {% endif %}

              {# ═══════════════════════════════════════════════════════════════
                 PR BADGES (conflicts, CI, review status)
                 ═══════════════════════════════════════════════════════════════ #}
              <div class="pr-badges">
                {% if pr.has_conflicts %}
                  <span class="badge badge-conflict">Conflicts</span>
                {% endif %}

                {% if pr.review_status %}
                  <span class="badge">{{ pr.review_status }}</span>
                {% endif %}

                {% if pr.ci_summary %}
                  {% set ci = pr.ci_summary.lower() %}
                  <span class="badge
                    {% if 'failed' in ci or 'failure' in ci %}badge-strong
                    {% elif 'pending' in ci or 'running' in ci %}ci-running
                    {% else %}ci-passed{% endif %}
                  ">{{ pr.ci_summary }}</span>
                {% endif %}

                {% if pr.state == "MERGED" and pr.merge_ci_summary %}
                  {% set mci = pr.merge_ci_summary.lower() %}
                  <span class="badge
                    {% if 'failed' in mci %}ci-failed
                    {% elif 'pending' in mci or 'running' in mci %}ci-running
                    {% else %}ci-passed{% endif %}
                  ">merge: {{ pr.merge_ci_summary }}</span>
                {% endif %}
              </div>

              {# ═══════════════════════════════════════════════════════════════
                 JIRA FOOTER STRIP
                 ═══════════════════════════════════════════════════════════════ #}
              {% if pr.jira_status and pr.jira_key %}
                {% set expected_jira = [] %}
                {% set jira_ok = True %}
                {% set assignee_warn = pr.is_mine and ((pr.jira_assignee_match is not none and not pr.jira_assignee_match) or (not pr.jira_assignee)) %}
                {% set allowed_targets = ["in development","in review","awaiting qa"] %}
                {% if pr.is_mine and pr.jira_status %}
                  {% set status_lower = pr.jira_status.lower() %}
                  {% if title == "My PRs that need review" %}
                    {% if pr.is_draft %}
                      {% set expected_jira = settings.jira_status_list(settings.jira_status_draft, []) %}
                    {% else %}
                      {% set expected_jira = settings.jira_status_list(settings.jira_status_needs_review, []) %}
                    {% endif %}
                  {% elif title == "My PRs that have been reviewed" %}
                    {% set expected_jira = settings.jira_status_list(settings.jira_status_reviewed, []) %}
                  {% elif title.startswith("Merged PRs") %}
                    {% set expected_jira = settings.jira_status_list(settings.jira_status_merged, []) %}
                    {% set expected_jira = expected_jira | reject('equalto', 'Ready for QA') | list %}
                  {% endif %}

                  {% if expected_jira %}
                    {% set filt = namespace(values=[]) %}
                    {% for val in expected_jira %}
                      {% if val and (val|lower) in allowed_targets %}
                        {% set _ = filt.values.append(val) %}
                      {% endif %}
                    {% endfor %}
                    {% set expected_jira = filt.values %}
                  {% endif %}

                  {% if expected_jira %}
                    {% set expected_lower = expected_jira | map('lower') | list %}
                    {% set jira_ok = status_lower in expected_lower %}
                  {% endif %}
                {% endif %}

                {% set extra = pr.jira_keys|length - 1 if pr.jira_keys else 0 %}

                <div class="jira-strip">
                  <span class="jira-strip-label">Jira</span>

                  <span class="jira-status" hx-preserve="true">
                    <span class="jira-status-key">
                      {% if pr.jira_url %}
                        <a href="{{ pr.jira_url }}" target="_blank" rel="noopener">{{ pr.jira_key }}</a>
                      {% else %}
                        {{ pr.jira_key }}
                      {% endif %}
                    </span>
                    <span class="jira-status-value {% if not jira_ok %}mismatch{% endif %}">
                      {{ pr.jira_status }}
                    </span>
                    {% if extra > 0 %}
                      <span class="jira-extra">(+{{ extra }} more)</span>
                    {% endif %}
                    {% if assignee_warn %}
                      <span class="jira-extra warn">Assignee mismatch</span>
                    {% endif %}
                    <span class="htmx-indicator"></span>
                  </span>

                  <span class="jira-divider"></span>

                  {% if pr.jira_assignee %}
                    <span class="jira-components">
                      <span class="jira-components-label">Assignee:</span>
                      {% set assignee_class = "matched" %}
                      {% if pr.is_mine and pr.jira_assignee_match is not none and not pr.jira_assignee_match %}
                        {% set assignee_class = "missing" %}
                      {% endif %}
                      <span class="jira-components-value {{ assignee_class }}">{{ pr.jira_assignee }}</span>
                    </span>
                  {% else %}
                    <span class="jira-components">
                      <span class="jira-components-label">Assignee:</span>
                      <span class="jira-components-value missing">None</span>
                    </span>
                  {% endif %}

                  <span class="jira-components">
                    <span class="jira-components-label">Components:</span>
                  {% if pr.jira_components %}
                    <span class="jira-components-value {% if pr.jira_components_match %}matched{% else %}missing{% endif %}">
                      {{ pr.jira_components | join(", ") }}
                    </span>
                  {% else %}
                    <span class="jira-components-value missing">None</span>
                  {% endif %}
                  </span>

                  {% set action_target = expected_jira|first if expected_jira else None %}
                  {% set action_allowed = action_target and (action_target | lower) in allowed_targets %}

                  {% if pr.is_mine and not jira_ok and expected_jira and action_allowed %}
                    {% set status_indicator = ("ind-status-" ~ pr.repo_name ~ "-" ~ pr.number)|replace(" ", "-") %}
                    <button
                      class="jira-fix-btn"
                      hx-post="/jira/{{ pr.jira_key }}/transition"
                      hx-vals='{"target": "{{ action_target }}", "lane": "{{ title }}", "is_draft": "{{ pr.is_draft }}"}'
                      hx-target="#pr-table-container"
                      hx-swap="morphdom"
                      hx-ext="morphdom-swap"
                      hx-indicator="#{{ status_indicator }}"
                      hx-on::before-request="this.disabled=true"
                      hx-headers='{"X-Requested-With": "XMLHttpRequest"}'
                    >
                      Set to {{ action_target }}
                    </button>
                    <span id="{{ status_indicator }}" class="htmx-indicator"></span>
                  {% endif %}

                  {% if pr.is_mine and settings.jira_components_enabled and (not pr.jira_components_match) %}
                    {% set comp_indicator = ("ind-comp-" ~ pr.repo_name ~ "-" ~ pr.number)|replace(" ", "-") %}
                    <button
                      class="jira-fix-btn"
                      hx-post="/jira/{{ pr.jira_key }}/components/fix"
                      hx-vals='{"repo": "{{ pr.repo_name }}"}'
                      hx-target="#pr-table-container"
                      hx-swap="morphdom"
                      hx-ext="morphdom-swap"
                      hx-indicator="#{{ comp_indicator }}"
                      hx-on::before-request="this.disabled=true"
                      hx-headers='{"X-Requested-With": "XMLHttpRequest"}'
                    >
                      Add repo component
                    </button>
                    <span id="{{ comp_indicator }}" class="htmx-indicator"></span>
                  {% endif %}

                  {% if pr.is_mine and pr.jira_assignee_match is not none and not pr.jira_assignee_match %}
                    {% set assign_indicator = ("ind-assign-" ~ pr.repo_name ~ "-" ~ pr.number)|replace(" ", "-") %}
                    <button
                      class="jira-fix-btn"
                      hx-post="/jira/{{ pr.jira_key }}/assign"
                      hx-target="#pr-table-container"
                      hx-swap="morphdom"
                      hx-ext="morphdom-swap"
                      hx-indicator="#{{ assign_indicator }}"
                      hx-on::before-request="this.disabled=true"
                      hx-headers='{"X-Requested-With": "XMLHttpRequest"}'
                    >
                      Assign to me
                    </button>
                    <span id="{{ assign_indicator }}" class="htmx-indicator"></span>
                  {% endif %}
                </div>
              {% endif %}

            </div>

          {% endfor %}
        </div>
      {% endif %}
    </section>
  {% endfor %}
</div>

<script>
  // Update last refresh timestamp on fragment load
  (function() {
    const el = document.getElementById("last-refresh");
    if (el && "{{ last_sync_str }}") {
      el.textContent = "{{ last_sync_str }}";
    }
  })();
</script>
