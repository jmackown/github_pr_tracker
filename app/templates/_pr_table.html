<div class="board">
  {% for title, items in groups %}
    <section class="board-section">
      <header class="section-header">
        <h2>
          {{ title }}{% if items|length is not none %} ({{ items|length }}){% endif %}
        </h2>
      </header>

      {% if items %}
        <div class="grid">
          {% for pr in items %}

            {# Determine strip colour #}
            {% set strip = "status-open" %}
            {% if pr.is_draft %}
                {% set strip = "status-draft" %}
            {% elif pr.state == "MERGED" %}
                {% set strip = "status-merged" %}
            {% elif pr.ci_summary and "FAILED" in pr.ci_summary %}
                {% set strip = "status-failed" %}
            {% endif %}

            <div class="card {% if pr.is_mine %}mine{% endif %}">
              <div class="status-strip {{ strip }}"></div>
              <div class="title">
                <a class="pr-link" href="{{ pr.url }}" target="_blank">
                  {{ pr.title }}
                </a>
                {% if pr.is_draft %}
                  <span class="pill pill-draft">Draft</span>
                {% endif %}
              </div>

              <div class="meta">
                <div class="avatar">
                  <img src="https://github.com/{{ pr.author }}.png" alt="">
                </div>
                <div>
                  <strong>{{ pr.author }}</strong><br>
                  <span>{{ pr.repo_owner }}/{{ pr.repo_name }} #{{ pr.number }}</span>
                </div>
              </div>

              <div class="meta">
                <span>Updated: {{ pr.updated_at }}</span>
              </div>
              {% if pr.state == "MERGED" %}
                <div class="meta">
                  <span>Merged: {{ pr.merged_at or pr.updated_at }}</span>
                </div>
              {% endif %}

              {% set size_points = pr.raw.get("size_sparkline", []) %}
              {% if size_points %}
                {% set max_val = size_points|max %}
                {% set total = size_points|length %}
                {% set fill_count = ((max_val * total) + 0.999) | int %}
                {% if max_val > 0 and fill_count < 1 %}{% set fill_count = 1 %}{% endif %}
                {% if fill_count > total %}{% set fill_count = total %}{% endif %}
                {% set last_idx = fill_count - 1 %}
                <div class="size-sparkline">
                  {% for val in size_points %}
                    {% set idx = loop.index0 %}
                    {% set filled = idx <= last_idx and max_val > 0 %}
                    {% set is_last = idx == last_idx and filled %}
                    {% set hue = 120 - (120 * val) %}
                    {% set height = 6 + (val * 12) %}
                    {% set alpha = 0.6 + (val * 0.4) %}
                    {% set glow = 6 + val * 10 %}
                    {% set fade = 0.15 + ((total - idx) / total) * 0.12 %}
                    {% set muted_opacity = fade if idx > last_idx else 0.55 %}
                    <span
                      class="size-spark-bar {% if filled %}filled{% else %}muted{% endif %} {% if is_last %}last-filled{% endif %}"
                      style="
                        height: {{ '%.1f' % height }}px;
                        {% if filled %}
                          background: linear-gradient(180deg, hsla({{ '%.0f' % hue }}, 80%, 60%, {{ '%.2f' % alpha }}), hsla({{ '%.0f' % hue }}, 80%, 50%, {{ '%.2f' % (alpha + 0.2) }}));
                          opacity: {{ '%.2f' % (0.6 + val * 0.4) }};
                          {% if is_last %}
                            box-shadow: 0 0 {{ '%.1f' % glow }}px hsla({{ '%.0f' % hue }}, 80%, 55%, {{ '%.2f' % (0.35 + val * 0.35) }});
                          {% endif %}
                        {% else %}
                          opacity: {{ '%.2f' % muted_opacity }};
                        {% endif %}
                      "
                    ></span>
                  {% endfor %}
                </div>
              {% endif %}

              {% set expected_jira = [] %}
              {% set jira_ok = True %}
              {% if pr.is_mine and pr.jira_status %}
                {% set status_lower = pr.jira_status.lower() %}
                {% if title == "My PRs that need review" %}
                  {% if pr.is_draft %}
                    {% set expected_jira = settings.jira_status_list(settings.jira_status_draft, ["In Development"]) %}
                  {% else %}
                    {% set expected_jira = settings.jira_status_list(settings.jira_status_needs_review, ["In Review"]) %}
                  {% endif %}
                {% elif title == "My PRs that have been reviewed" %}
                  {% set expected_jira = settings.jira_status_list(settings.jira_status_reviewed, ["In Review"]) %}
                {% elif title.startswith("Merged PRs") %}
                  {% set expected_jira = settings.jira_status_list(settings.jira_status_merged, ["Ready for QA","QA","In QA","Released","Done","Closed","Production"]) %}
                {% endif %}

                {% if expected_jira %}
                  {% set expected_lower = expected_jira | map('lower') | list %}
                  {% set jira_ok = status_lower in expected_lower %}
                {% endif %}
              {% endif %}

              <div class="meta badges-row">
                {% if pr.has_conflicts %}
                  <span class="badge badge-conflict">Conflicts</span>
                {% endif %}

                {% if pr.jira_status and pr.jira_key %}
                  {% set extra = pr.jira_keys|length - 1 if pr.jira_keys else 0 %}
                  <span class="badge {% if not jira_ok %}badge-strong{% else %}badge-jira{% endif %}">
                    {% if pr.jira_url %}
                      <a class="pr-link" href="{{ pr.jira_url }}" target="_blank" rel="noopener">{{ pr.jira_key }}</a>
                    {% else %}
                      {{ pr.jira_key }}
                    {% endif %}
                    : {{ pr.jira_status }}
                    {% if extra > 0 %} (+{{ extra }} more){% endif %}
                  </span>
                {% endif %}

                {% if pr.review_status %}
                  <span class="badge">
                    {{ pr.review_status }}
                  </span>
                {% endif %}

        {% if pr.ci_summary %}
          {% set ci = pr.ci_summary.lower() %}
          <span class="badge
            {% if 'failed' in ci or 'failure' in ci %}badge-strong
            {% elif 'pending' in ci or 'running' in ci %}ci-running
            {% else %}ci-passed{% endif %}
          ">
            {{ pr.ci_summary }}
          </span>
                {% endif %}

                {% if pr.state == "MERGED" and pr.merge_ci_summary %}
                  {% set mci = pr.merge_ci_summary.lower() %}
                  <span class="badge
                    {% if 'failed' in mci %}ci-failed
                    {% elif 'pending' in mci or 'running' in mci %}ci-running
                    {% else %}ci-passed{% endif %}
                  ">
                    merge: {{ pr.merge_ci_summary }}
                  </span>
                {% endif %}
              </div>

            </div>

          {% endfor %}
        </div>
      {% endif %}
    </section>
  {% endfor %}
</div>
